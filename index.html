<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pie Charts - Application Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Styl pro tlačítko, aby bylo umístěno vlevo nahoře */
        #refreshButton {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #refreshButton:hover {
            background-color: #0056b3;
        }

        /* Vycentrování nadpisu */
        h1 {
            text-align: center;
            margin-top: 20px;
        }

        /* Kontejner pro grafy, 2 sloupce a 2 řady */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;
            margin-top: 40px;
        }

        .chart-box {
            width: 100%;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body>
    <button id="refreshButton" onclick="location.reload();">Refresh Data</button>

    <h1>Application Status Distribution</h1>

    <!-- Kontejner pro čtyři grafy (2 sloupce, 2 řady) -->
    <div class="chart-container" id="chartContainer">
        <!-- Grafy budou generovány dynamicky -->
    </div>

    <script>
        // Funkce pro načtení dat a vytvoření grafu pro každý list
        async function loadExcelFileAndCreatePieCharts() {
            const fileUrl = 'data.xlsm';  // Cesta k tvému souboru XLSM
            const response = await fetch(fileUrl);
            const arrayBuffer = await response.arrayBuffer();

            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);

            const chartContainer = document.getElementById('chartContainer');
            let chartCount = 1;

            // Procházíme všechny listy v sešitu
            workbook.eachSheet(async (worksheet, sheetId) => {
                if (chartCount <= 4) {  // Omezíme počet grafů na 4
                    const chartBox = document.createElement('div');
                    chartBox.className = 'chart-box';
                    chartBox.innerHTML = `<h2>${worksheet.name}</h2><canvas id="statusChart${chartCount}"></canvas>`;
                    chartContainer.appendChild(chartBox);
                    
                    await createPieChartForWorksheet(worksheet, `statusChart${chartCount}`);
                    chartCount++;
                }
            });
        }

        // Funkce pro vytvoření grafu pro konkrétní list
        async function createPieChartForWorksheet(worksheet, canvasId) {
            const statusCounts = {};  // Objekt pro počítání jednotlivých stavů
            let totalApplications = 0;

            worksheet.eachRow((row, rowNumber) => {
                if (rowNumber > 1) {  // Předpokládáme, že první řádek jsou hlavičky
                    const status = row.getCell('A').value;
                    const application = row.getCell('B').value;

                    if (application) {
                        totalApplications++;  // Zvýšení počtu aplikací
                        if (statusCounts[status]) {
                            statusCounts[status]++;  // Zvýšení počtu aplikací pro tento stav
                        } else {
                            statusCounts[status] = 1;  // Inicializace počtu aplikací pro tento stav
                        }
                    }
                }
            });

            // Připravíme data pro graf
            const labels = Object.keys(statusCounts);  // Unikátní stavy
            const dataValues = Object.values(statusCounts).map(count => (count / totalApplications) * 100);  // Procentuální podíl

            // Vykreslení koláčového grafu pomocí Chart.js
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,  // Popisky pro stavy
                    datasets: [{
                        label: 'Application Status',
                        data: dataValues,  // Procentuální hodnoty
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    const status = tooltipItem.label;
                                    const percent = tooltipItem.raw.toFixed(2);  // Procento
                                    const count = statusCounts[status];  // Počet aplikací pro daný stav
                                    return `${status}: ${percent}% tj. ${count} z ${totalApplications}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Zavolání funkce pro načtení dat a vykreslení grafů
        loadExcelFileAndCreatePieCharts();
    </script>
</body>
</html>
